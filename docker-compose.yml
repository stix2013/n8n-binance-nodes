services:
  n8n:
    image: n8n-custom:${N8N_VERSION:-2.7.5}
    build:
      context: .
      dockerfile: dockers/Dockerfile.n8n
      args:
        - N8N_VERSION=${N8N_VERSION:-2.7.5}
    container_name: n8n-main
    restart: always
    user: "1000:1000"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - n8n_network
    ports:
      - "${N8N_HOST_PORT}:${N8N_PORT}" # Default n8n port: host_port:container_port
    environment:
      # General Settings
      - N8N_HOST="${N8N_HOST}"
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_BASIC_AUTH_ACTIVE="${N8N_BASIC_AUTH_ACTIVE}" # Highly recommended for local testing/production
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=${N8N_BLOCK_ENV_ACCESS_IN_NODE}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS}
      - N8N_DEV_RELOAD=${N8N_DEV_RELOAD}
      - N8N_PROXY_HOPS=1
      # File access
      - N8N_RESTRICT_FILE_ACCESS_TO=/home/node/analyse
      # Runners (N8N_RUNNERS_ENABLED removed - no longer needed)
      - N8N_RUNNERS_MODE=${N8N_RUNNERS_MODE}
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=${N8N_RUNNERS_BROKER_LISTEN_ADDRESS}
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_NATIVE_PYTHON_RUNNER=${N8N_NATIVE_PYTHON_RUNNER}
      - N8N_RUNNERS_EXTERNAL_ALLOW=${N8N_RUNNERS_EXTERNAL_ALLOW}
      - NODE_FUNCTION_ALLOW_EXTERNAL=${NODE_FUNCTION_ALLOW_EXTERNAL}
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=120000
      # Authentication (Replace with your desired credentials)
      - N8N_BASIC_AUTH_USER="${N8N_BASIC_AUTH_USER}"
      - N8N_BASIC_AUTH_PASSWORD="${N8N_BASIC_AUTH_PASSWORD}"
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=${N8N_GIT_NODE_DISABLE_BARE_REPOS}
      - N8N_COMMUNITY_PACKAGES_ENABLED=${N8N_COMMUNITY_PACKAGES_ENABLED}
      - N8N_CUSTOM_EXTENSIONS=/home/node/custom-extensions
      # Timezone (Change to your timezone, e.g., 'America/New_York')
      - TZ="${TZ}"

      # SQLite
      - DB_SQLITE_POOL_SIZE=${DB_SQLITE_POOL_SIZE}

      # Ngrok webhook
      - WEBHOOK_URL="${WEBHOOK_URL}"
      - WEBHOOK_TUNNEL_URL="${WEBHOOK_URL}"

    # Persist n8n data (workflows, credentials, etc.)
    volumes:
      - n8n_data:/home/node/.n8n
      - n8n_mcp:/data/mcp
      - ./docs/analyse:/home/node/analyse:rw
    extra_hosts:
      - "api.binance.com:108.156.104.23"
      - "fapi.binance.com:13.35.24.46"
    # You can remove this section if you don't need a specific limit
    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    healthcheck:
      test:
        [
          "CMD",
          "sh",
          "-c",
          '(wget -q -T 5 -O - http://localhost:5678/healthz 2>/dev/null | grep -qF ''{"status":"ok"}'') || exit 1',
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 3600s
  # n8n Tasks Runners
  task-runners:
    image: n8nio-runners:${N8N_VERSION:-2.7.5}-local
    build:
      context: ./dockers
      dockerfile: Dockerfile
      args:
        - N8N_VERSION=${N8N_VERSION:-2.7.5}
    restart: always
    container_name: n8n-runners
    networks:
      - n8n_network
    dns:
      - 8.8.8.8
      - 1.1.1.1
    extra_hosts:
      - "binance.com:3.170.91.76"
      - "www.binance.com:3.170.91.76"
      - "api.binance.com:108.156.104.23"
      - "developers.binance.com:18.172.242.31"
      - "fapi.binance.com:13.35.24.46"
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-main:5679
      - N8N_RESTRICT_FILE_ACCESS_TO=/home/node/analyse
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_LAUNCHER_LOG_LEVEL=${N8N_RUNNERS_LAUNCHER_LOG_LEVEL}
      - N8N_RUNNERS_EXTERNAL_ALLOW=${N8N_RUNNERS_EXTERNAL_ALLOW}
      - NODE_FUNCTION_ALLOW_EXTERNAL=${NODE_FUNCTION_ALLOW_EXTERNAL}
      - N8N_RUNNERS_TASK_RUNNER_CONFIG_PATH=/config/n8n-task-runners.json
      - NODE_OPTIONS="--max-old-space-size=1024"
      - N8N_RUNNERS_MAX_CONCURRENCY=5
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=120
    volumes:
      - ./config/n8n-task-runners.json:/etc/n8n-task-runners.json
      - ./docs/analyse:/home/node/analyse:rw
    depends_on:
      - n8n
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://n8n-main:5679/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
  postgres:
#    build:
#      context: ./dockers
#      dockerfile: Dockerfile.postgres
#    image: postgres:16-alpine-pgvector
    image: postgres:16-alpine
    restart: unless-stopped
    container_name: postgres-db
    ports:
      - 5432:5432
    networks:
      - n8n_network
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-n8n}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
  api:
    image: api-python${API_PYTHON_VERSION:-3.14}:${API_VERSION:-1.4.0}
    build:
      context: .
      dockerfile: dockers/Dockerfile.python
      args:
        - API_VERSION=${API_VERSION:-1.5.0}
    container_name: api
    restart: unless-stopped
    networks:
      - n8n_network
    ports:
      - "8000:8000"
    extra_hosts:
      - "api.binance.com:108.156.104.23"
    environment:
      - PYTHONUNBUFFERED=1
      - API_LOG_LEVEL=${API_LOG_LEVEL:-INFO}
    volumes:
      - ./api:/app
      - ./.env:/app/.env:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
volumes:
  n8n_data:
    external: true
    name: n8n_data
  n8n_mcp:
    external: true
    name: n8n_mcp
  postgres_data:
    external: true
    name: postgres_data
networks:
  n8n_network:
    name: n8n_network
