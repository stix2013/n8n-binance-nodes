services:
  n8n:
    image: n8nio/n8n:${N8N_VERSION:-2.9.4-amd64}
    container_name: n8n-main
    restart: always
    # user: "1000:1000"  # Commented out - caused issues
    dns:
      - 8.8.8.8
      - 1.1.1.1
    extra_hosts:
      - "binance.com:3.170.91.76"
      - "www.binance.com:3.170.91.76"
      - "api.binance.com:108.156.104.23"
      - "developers.binance.com:18.172.242.31"
      - "fapi.binance.com:13.35.24.46"
      - "host.docker.internal:192.168.0.14"
      - "host.local:192.168.0.14"
      - "fstream.binance.com:13.249.134.34"
      - "stream.binance.com:13.114.105.102"
    networks:
      - n8n_network
    ports:
      - "${N8N_HOST_PORT}:${N8N_PORT}" # Default n8n port: host_port:container_port
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=user
      - N8N_BASIC_AUTH_PASSWORD=password123
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=http
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - TZ=Asia/Jakarta
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_RESTRICT_FILE_ACCESS_TO=/home/node/analyse
      - N8N_RUNNERS_AUTH_TOKEN=MHPA2F2G1PL1Z6XdL3Yur1Pm23hbLM6J
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,uuid,@binance/spot,@binance/common,trading-signals
      - N8N_NATIVE_PYTHON_RUNNER=true
      - N8N_MIGRATE_FS_STORAGE_PATH=true
      - N8N_CUSTOM_EXTENSIONS=/home/node/.n8n/custom
      # DB 
      - DB_TYPE=${N8N_DB_TYPE:-postgresdb}
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}
      
      # Queue Mode
      # - EXECUTIONS_MODE=regular
      # - EXECUTIONS_PROCESS=main
      - EXECUTIONS_MODE=queue
      - EXECUTIONS_PROCESS=worker
      # - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_HEALTH_CHECK_ACTIVE=true

    # Persist n8n data (workflows, credentials, etc.)
    volumes:
      - n8n_storage:/home/node/.n8n
      - ./docs/analyse:/home/node/analyse:rw
      - ./nodes/@stix:/home/node/.n8n/custom:rw
    healthcheck:
      test:
        [
          "CMD",
          "sh",
          "-c",
          '(wget -q -T 5 -O - http://localhost:5678/healthz 2>/dev/null | grep -qF ''{"status":"ok"}'') || exit 1',
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 3600s
    depends_on:
      # task-runners:
      #   condition: service_healthy
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # n8n Tasks Runners
  task-runners:
    image: n8nio-runners-local:${N8N_VERSION:-2.7.5}
    build:
      context: .
      dockerfile: dockers/Dockerfile.runners
      args:
        - N8N_VERSION=${N8N_VERSION:-2.7.5}
    restart: always
    container_name: n8n-runners
    networks:
      - n8n_network
    dns:
      - 8.8.8.8
      - 1.1.1.1
    extra_hosts:
      - "binance.com:3.170.91.76"
      - "www.binance.com:3.170.91.76"
      - "api.binance.com:108.156.104.23"
      - "developers.binance.com:18.172.242.31"
      - "fapi.binance.com:13.35.24.46"
      - "fstream.binance.com:13.249.134.34"
      - "stream.binance.com:13.114.105.102"
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-main:5679
      - N8N_RESTRICT_FILE_ACCESS_TO=/home/node/analyse
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_LAUNCHER_LOG_LEVEL=${N8N_RUNNERS_LAUNCHER_LOG_LEVEL}
      - N8N_RUNNERS_EXTERNAL_ALLOW=${N8N_RUNNERS_EXTERNAL_ALLOW}
      - NODE_FUNCTION_ALLOW_EXTERNAL=${NODE_FUNCTION_ALLOW_EXTERNAL}
      - N8N_RUNNERS_TASK_RUNNER_CONFIG_PATH=/config/n8n-task-runners.json
      - NODE_OPTIONS="--max-old-space-size=1024"
      - N8N_RUNNERS_MAX_CONCURRENCY=5
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=120
    volumes:
      - ./config/n8n-task-runners.json:/etc/n8n-task-runners.json
      - ./docs/analyse:/home/node/analyse:rw
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://n8n-main:5679/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # API Python
  api:
    image: api-python${API_PYTHON_VERSION:-3.14}:${API_VERSION:-1.4.0}
    build:
      context: .
      dockerfile: dockers/Dockerfile.python
      args:
        - API_VERSION=${API_VERSION:-1.5.0}
    container_name: api
    restart: unless-stopped
    networks:
      - n8n_network
    ports:
      - "8000:8000"
    extra_hosts:
      - "api.binance.com:108.156.104.23"
    environment:
      - PYTHONUNBUFFERED=1
      - API_LOG_LEVEL=${API_LOG_LEVEL:-INFO}
    volumes:
      - ./api:/app
      - ./.env:/app/.env:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Postgres
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    container_name: postgres-db
    ports:
      - 5432:5432
    networks:
      - n8n_network
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-data.sh:/docker-entrypoint-initdb.d/init-data.sh
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-n8n}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_NON_ROOT_USER=${POSTGRES_NON_ROOT_USER:-n8n}
      - POSTGRES_NON_ROOT_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD:-postgres}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Redis for QUEUE
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - n8n_network
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 10

# Volumes
volumes:
  n8n_data:
    name: n8n_data
  n8n_storage:
    external: true
    name: n8n_storage
  n8n_mcp:
    name: n8n_mcp
  postgres_data:
    name: postgres_data
  rabbitmq_data:
    external: true
    name: rabbitmq_data
  redis_data:
    name: redis_data
networks:
  n8n_network:
    external: true
    name: n8n_network
